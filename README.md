# Kafka æºç å­¦ä¹ è¿›åº¦

## ğŸ“š å­¦ä¹ ç›®æ ‡
æ·±å…¥ç†è§£ Apache Kafka ç”Ÿäº§è€…çš„å·¥ä½œåŸç†ï¼Œé€šè¿‡æºç é˜…è¯»å’Œå®è·µæŒæ¡æ ¸å¿ƒæ¦‚å¿µã€‚

---

## âœ… å·²å®Œæˆçš„å­¦ä¹ å†…å®¹

### 1. ç¯å¢ƒæ­å»º
- âœ… Kafka æºç ä¸‹è½½å’Œé…ç½®
- âœ… Java ç¯å¢ƒéªŒè¯ï¼ˆOpenJDK 1.8.0ï¼‰
- âœ… Gradle æ„å»ºç³»ç»Ÿç†è§£

### 2. é›†ç¾¤é…ç½®ä¸å¯åŠ¨
- âœ… åˆ›å»º 3 Broker Kafka é›†ç¾¤
  - Broker 1: localhost:9092 (ID: 1)
  - Broker 2: localhost:9093 (ID: 2)
  - Broker 3: localhost:9094 (ID: 3)
  - ZooKeeper: localhost:2181
- âœ… é›†ç¾¤éªŒè¯å’Œæµ‹è¯•

### 3. ç”Ÿäº§è€…åŸºç¡€
- âœ… åˆ›å»º `my-producer-test` module
- âœ… å®ç° `SimpleProducer` ç±»
- âœ… å®ç° `ProducerDemo` æµ‹è¯•ç±»
- âœ… ç†è§£ç”Ÿäº§è€…é…ç½®é¡¹ï¼š
  - `BOOTSTRAP_SERVERS_CONFIG` - Broker åœ°å€
  - `KEY_SERIALIZER_CLASS_CONFIG` - Key åºåˆ—åŒ–å™¨
  - `VALUE_SERIALIZER_CLASS_CONFIG` - Value åºåˆ—åŒ–å™¨

### 4. æ¶ˆè´¹è€…åŸºç¡€
- âœ… å®ç° `SimpleConsumer` ç±»
- âœ… å®ç° `ConsumerDemo` æµ‹è¯•ç±»
- âœ… ç†è§£æ¶ˆè´¹è€…é…ç½®é¡¹ï¼š
  - `GROUP_ID_CONFIG` - æ¶ˆè´¹è€…ç»„ ID
  - `KEY_DESERIALIZER_CLASS_CONFIG` - Key ååºåˆ—åŒ–å™¨
  - `VALUE_DESERIALIZER_CLASS_CONFIG` - Value ååºåˆ—åŒ–å™¨
  - `AUTO_OFFSET_RESET_CONFIG` - åç§»é‡é‡ç½®ç­–ç•¥
  - `ENABLE_AUTO_COMMIT_CONFIG` - è‡ªåŠ¨æäº¤åç§»é‡

### 5. å¹‚ç­‰æ€§ç”Ÿäº§è€…
- âœ… ç†è§£æ¶ˆæ¯é¡ºåºé—®é¢˜
  - å½“ `retries > 0` ä¸” `max.in.flight.requests.per.connection > 1` æ—¶
  - ç¬¬ä¸€ä¸ªæ‰¹æ¬¡å¤±è´¥ï¼Œç¬¬äºŒä¸ªæ‰¹æ¬¡æˆåŠŸï¼Œé‡è¯•å¯¼è‡´é¡ºåºåè½¬
- âœ… å®ç° `IdempotentProducer` ç±»
- âœ… å®ç° `IdempotentProducerDemo` æ¼”ç¤º
- âœ… ç†è§£å¹‚ç­‰æ€§é…ç½®ï¼š
  - `enable.idempotence = true`
  - `max.in.flight.requests.per.connection â‰¤ 5`
  - `retries > 0`
  - `acks = all`

### 6. ä»£ç è´¨é‡æ”¹è¿›
- âœ… ä½¿ç”¨ SLF4J æ—¥å¿—æ›¿ä»£ `printStackTrace()`
- âœ… å°†å­—æ®µå£°æ˜ä¸º `final`
- âœ… éµå¾ª Kafka ä»£ç è§„èŒƒ

### 7. æºç é˜…è¯»
- âœ… æŸ¥çœ‹ `KafkaProducer.java` æºä»£ç 
- âœ… ç†è§£ `send()` æ–¹æ³•çš„ 15 ä¸ªæ­¥éª¤
- âœ… ç†è§£ `doSend()` æ–¹æ³•çš„å®Œæ•´å®ç°
- âœ… ä¸º JavaDoc æ·»åŠ ä¸­æ–‡æ³¨é‡Š

---

## ğŸ“– æ ¸å¿ƒçŸ¥è¯†ç‚¹

### send() æ–¹æ³•çš„ 15 ä¸ªæ­¥éª¤
1. éªŒè¯ç”Ÿäº§è€…çŠ¶æ€
2. è·å–é›†ç¾¤å…ƒæ•°æ®
3. åºåˆ—åŒ– Key
4. åºåˆ—åŒ– Value
5. é€‰æ‹©åˆ†åŒº
6. åˆ›å»º TopicPartition
7. ä¼°ç®—æ¶ˆæ¯å¤§å°
8. è®¾ç½®æ—¶é—´æˆ³
9. åˆ›å»ºæ‹¦æˆªå™¨å›è°ƒ
10. æ£€æŸ¥äº‹åŠ¡çŠ¶æ€
11. æ·»åŠ åˆ°ç´¯ç§¯å™¨
12. å¤„ç†æ–°æ‰¹æ¬¡
13. æ›´æ–°äº‹åŠ¡çŠ¶æ€
14. å”¤é†’å‘é€çº¿ç¨‹
15. è¿”å› Future

### ä¸‰ç§å‘é€æ–¹å¼
- **å¼‚æ­¥å‘é€ + å›è°ƒ**ï¼ˆæ¨èï¼‰- æ€§èƒ½å¥½ï¼Œèƒ½å¤„ç†é”™è¯¯
- **åŒæ­¥å‘é€** - è°ƒç”¨ `.get()` ç­‰å¾…ç»“æœ
- **å‘é€å¹¶å¿˜è®°** - ä¸å…³å¿ƒç»“æœ

### å…³é”®ç‰¹æ€§
- å¼‚æ­¥å‘é€ - ç«‹å³è¿”å›ï¼Œä¸é˜»å¡
- æ‰¹å¤„ç† - æ¶ˆæ¯å…ˆå­˜å…¥ç¼“å†²åŒºï¼Œç„¶åæ‰¹é‡å‘é€
- åˆ†åŒºé€‰æ‹© - ç›¸åŒ Key çš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€åˆ†åŒº
- é¡ºåºä¿è¯ - åŒä¸€åˆ†åŒºçš„æ¶ˆæ¯é¡ºåºæœ‰ä¿è¯
- äº‹åŠ¡æ”¯æŒ - æ”¯æŒäº‹åŠ¡æ€§å‘é€
- å¹‚ç­‰æ€§ - æ”¯æŒå¹‚ç­‰æ€§ç”Ÿäº§è€…

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
kafka-2.7.2/
â”œâ”€â”€ my-producer-test/                    # ç”Ÿäº§è€…æµ‹è¯• module
â”‚   â”œâ”€â”€ src/main/java/org/apache/kafka/test/
â”‚   â”‚   â”œâ”€â”€ SimpleProducer.java          # ç®€å•ç”Ÿäº§è€…
â”‚   â”‚   â”œâ”€â”€ ProducerDemo.java            # ç”Ÿäº§è€…æ¼”ç¤º
â”‚   â”‚   â”œâ”€â”€ SimpleConsumer.java          # ç®€å•æ¶ˆè´¹è€…
â”‚   â”‚   â”œâ”€â”€ ConsumerDemo.java            # æ¶ˆè´¹è€…æ¼”ç¤º
â”‚   â”‚   â”œâ”€â”€ IdempotentProducer.java      # å¹‚ç­‰æ€§ç”Ÿäº§è€…
â”‚   â”‚   â””â”€â”€ IdempotentProducerDemo.java  # å¹‚ç­‰æ€§æ¼”ç¤º
â”‚   â”œâ”€â”€ build.gradle                     # Gradle é…ç½®
â”‚   â”œâ”€â”€ run-producer.sh                  # ç”Ÿäº§è€…è¿è¡Œè„šæœ¬
â”‚   â””â”€â”€ run-consumer.sh                  # æ¶ˆè´¹è€…è¿è¡Œè„šæœ¬
â”‚
â”œâ”€â”€ cluster/                             # é›†ç¾¤é…ç½®
â”‚   â”œâ”€â”€ zookeeper.properties             # ZooKeeper é…ç½®
â”‚   â”œâ”€â”€ broker-1.properties              # Broker 1 é…ç½®
â”‚   â”œâ”€â”€ broker-2.properties              # Broker 2 é…ç½®
â”‚   â””â”€â”€ broker-3.properties              # Broker 3 é…ç½®
â”‚
â”œâ”€â”€ clients/src/main/java/org/apache/kafka/clients/producer/
â”‚   â””â”€â”€ KafkaProducer.java               # ç”Ÿäº§è€…æºä»£ç ï¼ˆå·²æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼‰
â”‚
â”œâ”€â”€ setup-cluster.sh                     # é›†ç¾¤é…ç½®è„šæœ¬
â”œâ”€â”€ start-cluster.sh                     # é›†ç¾¤å¯åŠ¨è„šæœ¬
â”œâ”€â”€ stop-cluster.sh                      # é›†ç¾¤åœæ­¢è„šæœ¬
â”œâ”€â”€ test-cluster.sh                      # é›†ç¾¤æµ‹è¯•è„šæœ¬
â”œâ”€â”€ verify-cluster.sh                    # é›†ç¾¤éªŒè¯è„šæœ¬
â”‚
â””â”€â”€ æ–‡æ¡£/
    â”œâ”€â”€ PRODUCER_SEND_JAVADOC_CN.md      # send() æ–¹æ³• JavaDoc ä¸­æ–‡ç¿»è¯‘
    â”œâ”€â”€ PRODUCER_SEND_DETAILS.md         # send() æ–¹æ³•è¯¦ç»†è§£æ
    â”œâ”€â”€ IDEMPOTENCE.md                   # å¹‚ç­‰æ€§ç”Ÿäº§è€…è¯¦è§£
    â”œâ”€â”€ CLUSTER_SETUP.md                 # é›†ç¾¤é…ç½®æŒ‡å—
    â”œâ”€â”€ CLUSTER_QUICK_START.md           # é›†ç¾¤å¿«é€Ÿå‚è€ƒ
    â”œâ”€â”€ CLUSTER_STATUS.md                # é›†ç¾¤çŠ¶æ€æ€»ç»“
    â””â”€â”€ SOURCE_CODE_REFERENCE.md         # æºä»£ç å‚è€ƒ
```

---

## ğŸš€ å¿«é€Ÿå‘½ä»¤

### å¯åŠ¨é›†ç¾¤
```bash
cd /Users/heybox/Downloads/kafka-2.7.2
bash setup-cluster.sh      # ç”Ÿæˆé…ç½®
bash start-cluster.sh      # å¯åŠ¨é›†ç¾¤
bash test-cluster.sh       # æµ‹è¯•é›†ç¾¤
```

### è¿è¡Œç”Ÿäº§è€…
```bash
java -cp "my-producer-test/build/libs/kafka-my-producer-test-2.7.2.jar:clients/build/libs/kafka-clients-2.7.2.jar" \
  org.apache.kafka.test.ProducerDemo
```

### è¿è¡Œæ¶ˆè´¹è€…
```bash
java -cp "my-producer-test/build/libs/kafka-my-producer-test-2.7.2.jar:clients/build/libs/kafka-clients-2.7.2.jar" \
  org.apache.kafka.test.ConsumerDemo
```

### è¿è¡Œå¹‚ç­‰æ€§ç”Ÿäº§è€…
```bash
java -cp "my-producer-test/build/libs/kafka-my-producer-test-2.7.2.jar:clients/build/libs/kafka-clients-2.7.2.jar" \
  org.apache.kafka.test.IdempotentProducerDemo
```

### ç¼–è¯‘é¡¹ç›®
```bash
./gradlew :my-producer-test:build
```

---

## ğŸ“Š é›†ç¾¤æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Kafka 3 Broker é›†ç¾¤                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”â”‚
â”‚  â”‚  Broker 1    â”‚  â”‚  Broker 2    â”‚  â”‚Br 3â”‚â”‚
â”‚  â”‚  Port 9092   â”‚  â”‚  Port 9093   â”‚  â”‚9094â”‚â”‚
â”‚  â”‚  ID: 1       â”‚  â”‚  ID: 2       â”‚  â”‚ID:3â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                 â”‚              â”‚  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                    â”‚  ZooKeeper   â”‚          â”‚
â”‚                    â”‚  Port 2181   â”‚          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æºä»£ç ä½ç½®

### å…³é”®æ–‡ä»¶
| æ–‡ä»¶ | è¡Œå· | è¯´æ˜ |
|------|------|------|
| KafkaProducer.java | 773-775 | send() æ–¹æ³•å…¥å£ |
| KafkaProducer.java | 883-887 | send() æ–¹æ³•å®šä¹‰ |
| KafkaProducer.java | 899-1000 | doSend() å®ç° |
| KafkaProducer.java | 777-921 | JavaDocï¼ˆå·²æ·»åŠ ä¸­æ–‡ï¼‰ |

### æŸ¥çœ‹æºä»£ç 
```bash
# æŸ¥çœ‹ send() æ–¹æ³•çš„ JavaDoc
sed -n '777,921p' clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java

# æŸ¥çœ‹ doSend() æ–¹æ³•
sed -n '899,1000p' clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å­¦ä¹ è®¡åˆ’

### å¾…å­¦ä¹ å†…å®¹
- [ ] æ·±å…¥ç†è§£ RecordAccumulator æ‰¹å¤„ç†æœºåˆ¶
- [ ] å­¦ä¹  Sender çº¿ç¨‹çš„å·¥ä½œåŸç†
- [ ] ç†è§£åˆ†åŒºå™¨çš„å®ç°
- [ ] å­¦ä¹ æ‹¦æˆªå™¨æœºåˆ¶
- [ ] ç†è§£å…ƒæ•°æ®ç®¡ç†
- [ ] å­¦ä¹ æ¶ˆè´¹è€…çš„ poll() æœºåˆ¶
- [ ] ç†è§£æ¶ˆè´¹è€…ç»„åè°ƒ
- [ ] å­¦ä¹ äº‹åŠ¡å®ç°åŸç†
- [ ] ç†è§£å‰¯æœ¬åŒæ­¥æœºåˆ¶
- [ ] å­¦ä¹  Leader é€‰ä¸¾ç®—æ³•

---

## ğŸ“š å‚è€ƒèµ„æº

- **Kafka å®˜æ–¹æ–‡æ¡£ï¼š** https://kafka.apache.org/documentation/
- **ç”Ÿäº§è€…é…ç½®ï¼š** https://kafka.apache.org/documentation/#producerconfigs
- **æ¶ˆè´¹è€…é…ç½®ï¼š** https://kafka.apache.org/documentation/#consumerconfigs
- **æºä»£ç ï¼š** `/Users/heybox/Downloads/kafka-2.7.2/clients/src/main/java/org/apache/kafka/clients/producer/`

---

## ğŸ’¡ å­¦ä¹ å¿ƒå¾—

### å…³é”®å‘ç°
1. **å¼‚æ­¥è®¾è®¡** - Kafka ç”Ÿäº§è€…é‡‡ç”¨å¼‚æ­¥è®¾è®¡ï¼Œé€šè¿‡ RecordAccumulator ç¼“å†²åŒºå®ç°æ‰¹å¤„ç†
2. **é¡ºåºä¿è¯** - åŒä¸€åˆ†åŒºçš„æ¶ˆæ¯é¡ºåºç”± Key å†³å®šï¼Œç›¸åŒ Key çš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€åˆ†åŒº
3. **å¹‚ç­‰æ€§** - é€šè¿‡é™åˆ¶å¹¶å‘è¯·æ±‚æ•°å’Œé‡è¯•æœºåˆ¶å®ç°å¹‚ç­‰æ€§
4. **æ€§èƒ½ä¼˜åŒ–** - æ‰¹å¤„ç†ã€å‹ç¼©ã€å¼‚æ­¥å‘é€ç­‰æœºåˆ¶æé«˜ååé‡

### å­¦ä¹ æ–¹æ³•
1. å…ˆç†è§£é«˜å±‚æ¦‚å¿µï¼ˆç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€åˆ†åŒºç­‰ï¼‰
2. å†æ·±å…¥æºä»£ç ç†è§£å®ç°ç»†èŠ‚
3. é€šè¿‡å®è·µä»£ç åŠ æ·±ç†è§£
4. å¯¹æ¯”ä¸åŒçš„å‘é€æ–¹å¼ç†è§£æƒè¡¡

---

**æœ€åæ›´æ–°ï¼š** 2026-01-18
**å­¦ä¹ è¿›åº¦ï¼š** åŸºç¡€é˜¶æ®µå®Œæˆï¼Œè¿›å…¥æ·±å…¥å­¦ä¹ é˜¶æ®µ
